<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–µ–∫-–ª–∏—Å—Ç—ã ITSSupport</title>
  <meta name="theme-color" content="#0b2740">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b2740;
      --secondary: #123b63;
      --accent: #00b0ff;
      --accent2: #00e5c0;
      --bg-main: #eef3fa;
      --card-bg: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --progress-bg: #dde6f2;
      --border: #dce6f5;
      --text: #0f1f33;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Syne', sans-serif;
      background: #eef3fa;
      min-height: 100vh;
      color: var(--text);
      position: relative;
    }

    /* Subtle grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(0,176,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,176,255,0.04) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    header {
      background: linear-gradient(135deg, #0b2740 0%, #0e3560 60%, #123b63 100%);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 24px rgba(11,39,64,0.4);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(0,176,255,0.2);
    }

    header img {
      max-height: 52px;
      max-width: 320px;
      height: auto;
      filter: drop-shadow(0 2px 8px rgba(0,176,255,0.35));
    }

    .header-badge {
      position: absolute;
      right: 20px;
      background: rgba(0,176,255,0.12);
      border: 1px solid rgba(0,176,255,0.3);
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .container {
      max-width: 860px;
      margin: 28px auto 120px auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    .page-title {
      color: var(--primary);
      font-size: 1.6em;
      font-weight: 800;
      text-align: center;
      margin-bottom: 22px;
      letter-spacing: -0.02em;
    }

    /* Intro panel */
    .intro {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      padding: 18px 22px;
      border-radius: 14px;
      margin-bottom: 26px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07);
    }

    .intro-field {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .intro-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      white-space: nowrap;
    }

    .intro input {
      padding: 7px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      background: #f8fafd;
      color: var(--text);
      transition: border-color 0.2s;
      outline: none;
    }
    .intro input:focus {
      border-color: var(--accent);
      background: #fff;
    }
    .intro input#workDate { width: 160px; }
    .intro input#workerName { width: 190px; }

    .intro-hint {
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      padding-top: 2px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Task groups */
    .task-group {
      margin-bottom: 18px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(11,39,64,0.06);
      overflow: hidden;
      transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .task-group:hover {
      box-shadow: 0 12px 32px rgba(11,39,64,0.11);
      border-color: rgba(0,176,255,0.3);
    }

    .group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }

    .group-header:hover { background: #f8fafd; }

    .group-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .group-header h2 {
      color: var(--primary);
      font-size: 1em;
      font-weight: 700;
      letter-spacing: -0.01em;
      flex: 1;
    }

    .group-stats {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      background: #f0f4fa;
      padding: 3px 10px;
      border-radius: 20px;
      font-weight: 600;
    }

    .group-chevron {
      font-size: 12px;
      color: var(--muted);
      transition: transform 0.3s ease;
    }
    .task-group.open .group-chevron { transform: rotate(180deg); }

    /* Progress bar */
    .progress-container {
      height: 4px;
      background: var(--progress-bg);
      margin: 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width 0.45s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 8px rgba(0,176,255,0.5);
    }

    /* Subtasks */
    .subtasks {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-group.open .subtasks { max-height: 800px; }

    .subtasks-inner {
      padding: 12px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .subtask {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #f8fafd;
      border-radius: 10px;
      border: 1.5px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .subtask:hover {
      background: #eef5ff;
      border-color: rgba(0,176,255,0.25);
      transform: translateX(3px);
    }

    .subtask.completed {
      background: #edfbf5;
      border-color: rgba(16,185,129,0.25);
    }

    .subtask input[type="checkbox"] {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .subtask-emoji {
      font-size: 16px;
      flex-shrink: 0;
      width: 22px;
      text-align: center;
    }

    .subtask span {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      line-height: 1.4;
      transition: color 0.2s;
    }

    .subtask.completed span {
      text-decoration: line-through;
      color: #94a3b8;
    }

    .task-count {
      width: 64px;
      padding: 5px 8px;
      border-radius: 7px;
      border: 1.5px solid var(--border);
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      background: #fff;
      color: var(--text);
      text-align: center;
      flex-shrink: 0;
      transition: border-color 0.2s;
      outline: none;
    }
    .task-count:focus { border-color: var(--accent); }

    /* Group color accents */
    .g-morning .group-icon { background: #fff7ed; }
    .g-prep    .group-icon { background: #eff6ff; }
    .g-round   .group-icon { background: #f0fdf4; }
    .g-front   .group-icon { background: #fdf4ff; }
    .g-tags    .group-icon { background: #fff9f0; }
    .g-evening .group-icon { background: #f0f4ff; }

    .g-morning  { border-top: 3px solid #fb923c; }
    .g-prep     { border-top: 3px solid #60a5fa; }
    .g-round    { border-top: 3px solid #34d399; }
    .g-front    { border-top: 3px solid #a78bfa; }
    .g-tags     { border-top: 3px solid #fbbf24; }
    .g-evening  { border-top: 3px solid #818cf8; }

    /* Sticky actions */
    .actions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 20px;
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(16px);
      border-radius: 999px;
      box-shadow: 0 16px 40px rgba(11,39,64,0.18);
      border: 1px solid var(--border);
      z-index: 999;
      white-space: nowrap;
    }

    .btn {
      padding: 8px 20px;
      border: none;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-family: 'Syne', sans-serif;
      display: flex;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.02em;
    }

    .btn-reset {
      background: #f1f5f9;
      color: #64748b;
      border: 1.5px solid #e2e8f0;
    }
    .btn-reset:hover { background: #e2e8f0; }

    .btn-export {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #04111f;
      box-shadow: 0 4px 14px rgba(0,176,255,0.35);
    }
    .btn-export:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,176,255,0.45);
    }

    #totalProgress {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 16px;
      color: var(--primary);
      min-width: 46px;
      text-align: center;
    }

    /* Confetti */
    #confetti {
      position: fixed;
      top: 0; left: 0;
      pointer-events: none;
      z-index: 1000;
    }

    @media (max-width: 520px) {
      .actions {
        left: 12px; right: 12px;
        transform: none;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn { flex: 1; justify-content: center; min-width: 130px; }
      .page-title { font-size: 1.2em; }
    }
  </style>
</head>
<body>
  <header>
    <img src="./images/ITS_logo_horizont.png" alt="ITSSupport"
         onerror="this.src='https://via.placeholder.com/280x52/0b2740/00b0ff?text=ITSSupport'">
    <span class="header-badge">–î–µ–∂—É—Ä–Ω—ã–π</span>
  </header>

  <div class="container">
    <h1 class="page-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –¥–µ–∂—É—Ä–Ω–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞</h1>

    <div class="intro">
      <div class="intro-field">
        <span class="intro-label">üìÖ –î–∞—Ç–∞</span>
        <input type="date" id="workDate">
      </div>
      <div class="intro-field">
        <span class="intro-label">üë∑ –§–ò–û</span>
        <input type="text" id="workerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
      </div>
      <div class="intro-hint">‚Üì –ù–∞–∂–º–∏ –Ω–∞ –±–ª–æ–∫ —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å ¬∑ –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–¥–∞—á—É —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å</div>
    </div>

    <!-- –£–¢–†–û -->
    <div class="task-group g-morning" data-group="morning">
      <div class="group-header">
        <div class="group-icon">üåÑ</div>
        <h2>–£—Ç—Ä–æ (6:00 ‚Äì 8:00)</h2>
        <span class="group-stats" data-stats="morning">0/2</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="morning"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-1">
          <span class="subtask-emoji">ü™™</span>
          <span>–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∞ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-2">
          <span class="subtask-emoji">‚åö</span>
          <span>–í—ã–¥–∞—Ç—å —á–∞—Å—ã –≤ –æ–∫–Ω–µ 6:00‚Äì8:00. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–∫–∏ —Å —á–∞—Å–∞–º–∏</span>
        </div>
      </div></div>
    </div>

    <!-- –ü–û–î–ì–û–¢–û–í–ö–ê -->
    <div class="task-group g-prep" data-group="prep">
      <div class="group-header">
        <div class="group-icon">üéí</div>
        <h2>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±—Ö–æ–¥—É</h2>
        <span class="group-stats" data-stats="prep">0/3</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="prep"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-1">
          <span class="subtask-emoji">‚ñ∂Ô∏è</span>
          <span>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–º–µ–Ω—É –Ω–∞ —á–∞—Å–∞—Ö, –≤–∑—è—Ç—å –æ—Ç–ª–∞–¥–∫—É</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-2">
          <span class="subtask-emoji">üì≤</span>
          <span>–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫–∏ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-3">
          <span class="subtask-emoji">üß∞</span>
          <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—é–∫–∑–∞–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º</span>
        </div>
      </div></div>
    </div>

    <!-- –û–ë–•–û–î -->
    <div class="task-group g-round" data-group="round">
      <div class="group-header">
        <div class="group-icon">üö∂</div>
        <h2>–í–æ –≤—Ä–µ–º—è –æ–±—Ö–æ–¥–∞</h2>
        <span class="group-stats" data-stats="round">0/2</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="round"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="round-1">
          <span class="subtask-emoji">üå°Ô∏è</span>
          <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–Ω–∫—Ç–æ–≤ –≤—ã–¥–∞—á–∏ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–º–µ—â–µ–Ω–∏—è, –≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–∞—Å—ã)</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="round-2">
          <span class="subtask-emoji">üìã</span>
          <span>–§–∏–∫—Å–∞—Ü–∏—è –∑–∞–º–µ—á–∞–Ω–∏–π –ø–æ —Ç–æ—á–∫–∞–º –æ–±—Ö–æ–¥–∞</span>
        </div>
      </div></div>
    </div>

    <!-- –§–†–û–ù–¢ -->
    <div class="task-group g-front" data-group="front">
      <div class="group-header">
        <div class="group-icon">üñ•Ô∏è</div>
        <h2>–î–µ–Ω—å: –§—Ä–æ–Ω—Ç (–Ω–æ–≤–µ–Ω—å–∫–∏–µ, –±–æ—Ç, —Ç–∞–±–µ–ª—å)</h2>
        <span class="group-stats" data-stats="front">0/3</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="front"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="front-1">
          <span class="subtask-emoji">üÜï</span>
          <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–∏—á–∫–æ–≤</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-1">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="front-2">
          <span class="subtask-emoji">ü§ñ</span>
          <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–µ</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-2">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="front-3">
          <span class="subtask-emoji">üìä</span>
          <span>–û–±—Ä–∞—â–µ–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–∞–±–µ–ª–µ–º</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-3">
        </div>
      </div></div>
    </div>

    <!-- –ú–ï–¢–ö–ò -->
    <div class="task-group g-tags" data-group="tags">
      <div class="group-header">
        <div class="group-icon">üì°</div>
        <h2>–î–µ–Ω—å: –ú–µ—Ç–∫–∏ (BLE)</h2>
        <span class="group-stats" data-stats="tags">0/4</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="tags"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-1">
          <span class="subtask-emoji">‚úÖ</span>
          <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="tags-1">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-2">
          <span class="subtask-emoji">‚ûï</span>
          <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="tags-2">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-3">
          <span class="subtask-emoji">‚ö†Ô∏è</span>
          <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="tags-3">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-4">
          <span class="subtask-emoji">üîÑ</span>
          <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∂—É—Ä–Ω–∞–ª BLE / backend)</span>
        </div>
      </div></div>
    </div>

    <!-- –í–ï–ß–ï–† -->
    <div class="task-group g-evening" data-group="evening">
      <div class="group-header">
        <div class="group-icon">üåô</div>
        <h2>–í–µ—á–µ—Ä (18:00 ‚Äì 19:30)</h2>
        <span class="group-stats" data-stats="evening">0/2</span>
        <span class="group-chevron">‚ñº</span>
      </div>
      <div class="progress-container"><div class="progress-bar" data-group="evening"></div></div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-1">
          <span class="subtask-emoji">üö´</span>
          <span>–ù–∞—Ä—É—à–µ–Ω–∏—è</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="evening-1">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-2">
          <span class="subtask-emoji">üîê</span>
          <span>–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞</span>
        </div>
      </div></div>
    </div>
  </div>

  <!-- Sticky actions -->
  <div class="actions">
    <button class="btn btn-reset" onclick="resetAll()">‚Ü∫ –°–±—Ä–æ—Å</button>
    <div id="totalProgress">0%</div>
    <button class="btn btn-export" onclick="exportReport()">üìÑ –û—Ç—á—ë—Ç</button>
  </div>

  <canvas id="confetti"></canvas>

  <script>
    const STORAGE_KEY = 'itssupport_checklist_v4';

    function saveState() {
      const state = {
        tasks: Array.from(document.querySelectorAll('input[type="checkbox"]'))
          .map(cb => ({ id: cb.dataset.taskId, checked: cb.checked })),
        date: document.getElementById('workDate').value,
        name: document.getElementById('workerName').value,
        groups: Array.from(document.querySelectorAll('.task-group'))
          .map(g => ({ id: g.dataset.group, open: g.classList.contains('open') })),
        counts: Array.from(document.querySelectorAll('.task-count'))
          .map(inp => ({ id: inp.dataset.countFor, value: inp.value }))
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved) {
          saved.tasks?.forEach(({ id, checked }) => {
            const cb = document.querySelector(`[data-task-id="${id}"]`);
            if (cb) {
              cb.checked = checked;
              cb.closest('.subtask').classList.toggle('completed', checked);
            }
          });
          if (saved.date) document.getElementById('workDate').value = saved.date;
          if (saved.name) document.getElementById('workerName').value = saved.name;
          saved.groups?.forEach(({ id, open }) => {
            const group = document.querySelector(`[data-group="${id}"]`);
            if (group && open) group.classList.add('open');
          });
          saved.counts?.forEach(({ id, value }) => {
            const inp = document.querySelector(`.task-count[data-count-for="${id}"]`);
            if (inp) inp.value = value;
          });
        }
      } catch (e) {}
      updateAllProgress();
    }

    function updateGroupProgress(groupId) {
      const group = document.querySelector(`[data-group="${groupId}"]`);
      const tasks = group.querySelectorAll('input[type="checkbox"]');
      const checked = group.querySelectorAll('input[type="checkbox"]:checked').length;
      const percent = tasks.length ? Math.round((checked / tasks.length) * 100) : 0;
      group.querySelector('.progress-bar').style.width = percent + '%';
      // update stats badge
      const stats = group.querySelector(`[data-stats="${groupId}"]`);
      if (stats) stats.textContent = `${checked}/${tasks.length}`;
      return { checked, total: tasks.length };
    }

    function updateAllProgress() {
      let totalTasks = 0, totalChecked = 0;
      document.querySelectorAll('.task-group').forEach(group => {
        const r = updateGroupProgress(group.dataset.group);
        totalTasks += r.total;
        totalChecked += r.checked;
      });
      const pct = totalTasks ? Math.round((totalChecked / totalTasks) * 100) : 0;
      document.getElementById('totalProgress').textContent = pct + '%';
      if (pct === 100) showConfetti();
    }

    function resetAll() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏?')) return;
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.closest('.subtask').classList.remove('completed');
      });
      document.querySelectorAll('.task-count').forEach(inp => inp.value = 0);
      updateAllProgress();
      saveState();
    }

    function showConfetti() {
      const canvas = document.getElementById('confetti');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');
      const pieces = Array.from({length: 120}, () => ({
        x: Math.random() * canvas.width,
        y: -10,
        vx: (Math.random() - 0.5) * 8,
        vy: Math.random() * 4 + 4,
        color: ['#00b0ff','#00e5c0','#fbbf24','#a78bfa','#fb923c'][Math.floor(Math.random()*5)],
        size: Math.random() * 7 + 3,
        rot: Math.random() * 360,
        rs: (Math.random() - 0.5) * 8
      }));
      function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        pieces.forEach((p,i) => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.rs;
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI/180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
          if (p.y > canvas.height) pieces.splice(i,1);
        });
        if (pieces.length) requestAnimationFrame(draw);
        else ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      draw();
    }

    function exportReport() {
      const name = document.getElementById('workerName').value || '–ò–Ω–∂–µ–Ω–µ—Ä';
      const date = document.getElementById('workDate').value || new Date().toLocaleDateString('ru-RU');
      const progress = document.getElementById('totalProgress').textContent;

      const counts = Array.from(document.querySelectorAll('.task-count'))
        .map(inp => {
          const id = inp.dataset.countFor;
          const value = parseInt(inp.value || '0') || 0;
          const subtask = document.querySelector(`.subtask input[data-task-id="${id}"]`)?.closest('.subtask');
          const label = subtask?.querySelector('span')?.textContent.trim() ?? id;
          return { label, value };
        }).filter(i => i.value > 0);

      let report = `üìã ITSSupport ‚Äî –ß–µ–∫-–ª–∏—Å—Ç –¥–µ–∂—É—Ä–Ω–æ–≥–æ\n`;
      report += `üë∑ ${name}   üìÖ ${date}\n`;
      report += `‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${progress}\n\n`;
      if (counts.length) {
        report += `üì¶ –°—á—ë—Ç—á–∏–∫–∏:\n`;
        counts.forEach(c => { report += `  ‚Ä¢ ${c.label}: ${c.value}\n`; });
        report += `\n`;
      }
      report += `–ë–ª–æ–∫–∏:\n`;
      document.querySelectorAll('.task-group').forEach(group => {
        const title = group.querySelector('h2').textContent.trim();
        const stats = group.querySelector('[data-stats]').textContent;
        report += `  ${title}: ${stats}\n`;
      });

      navigator.clipboard.writeText(report).then(() => {
        alert('‚úÖ –û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!\n–í—Å—Ç–∞–≤—å –≤ Telegram –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É.');
      }).catch(() => { prompt('–°–∫–æ–ø–∏—Ä—É–π:', report); });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('workDate').valueAsDate = new Date();
      loadState();

      // Toggle groups
      document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('open');
          saveState();
        });
      });

      // Toggle subtasks
      document.querySelectorAll('.subtask').forEach(subtask => {
        subtask.addEventListener('click', function(e) {
          if (e.target.classList.contains('task-count')) return;
          const cb = this.querySelector('input[type="checkbox"]');
          if (e.target !== cb) cb.checked = !cb.checked;
          this.classList.toggle('completed', cb.checked);
          updateAllProgress();
          saveState();
        });
      });

      document.querySelectorAll('.task-count').forEach(inp => {
        inp.addEventListener('input', saveState);
        inp.addEventListener('click', e => e.stopPropagation());
      });
    });

    window.addEventListener('beforeunload', saveState);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) saveState(); });
  </script>
</body>
</html>
