<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–µ–∫-–ª–∏—Å—Ç –¥–µ–∂—É—Ä–Ω–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞</title>
  <meta name="theme-color" content="#0b2740">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b2740;
      --secondary: #123b63;
      --accent: #00b0ff;
      --bg-main: #f0f4f9;
      --card-bg: #ffffff;
      --muted: #5a6a7e;
      --success: #10b981;
      --warning: #f59e0b;
      --progress-bg: #dde4ee;
      --glass-bg: rgba(255,255,255,0.92);
      --border: #dde4ee;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Source Sans 3', sans-serif;
      background: #eef2f8;
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(0,176,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse at 80% 100%, rgba(11,39,64,0.07) 0%, transparent 55%);
      margin: 0; padding: 0; min-height: 100vh;
      overscroll-behavior: none;
      color: #1a2a3a;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: linear-gradient(90deg, #0b2740 0%, #0e3359 60%, #123b63 100%);
      padding: 0;
      box-shadow: 0 4px 24px rgba(11,39,64,0.45);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 2px solid rgba(0,176,255,0.3);
    }
    .header-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header img {
      height: 36px;
      width: auto;
      max-width: 160px;
      object-fit: contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    }
    .header-title {
      font-family: 'Oswald', sans-serif;
      font-size: 0.75em;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      border-left: 1px solid rgba(255,255,255,0.2);
      padding-left: 16px;
    }

    /* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
    .container {
      max-width: 900px; margin: 0 auto 40px auto; padding: 24px 20px;
    }

    /* ‚îÄ‚îÄ INTRO ‚îÄ‚îÄ */
    .intro {
      background: var(--glass-bg);
      padding: 18px 22px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(11,39,64,0.08);
    }
    .intro-field {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .intro-field label {
      font-family: 'Oswald', sans-serif;
      font-size: 0.78em;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
    }
    .intro input {
      padding: 7px 11px;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: 14px;
      font-family: 'Source Sans 3', sans-serif;
      background: #f8fafc;
      color: #1a2a3a;
      transition: border-color 0.2s;
    }
    .intro input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .intro input::placeholder { color: #a0b0c0; }
    #workDate { width: 160px; }
    #workerName { width: 180px; }
    .intro-hint {
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      margin: 0;
      padding-top: 4px;
      border-top: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ TASK GROUP ‚îÄ‚îÄ */
    .task-group {
      margin-bottom: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .task-group:hover {
      box-shadow: 0 8px 28px rgba(11,39,64,0.12);
      border-color: rgba(0,176,255,0.35);
    }
    .group-header {
      padding: 16px 20px 14px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: background 0.2s;
    }
    .group-header:hover { background: #f7fafd; }
    .group-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-group h2 {
      font-family: 'Oswald', sans-serif;
      color: var(--primary);
      margin: 0;
      font-size: 1.05em;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .task-group h2 .icon { font-size: 1.1em; line-height: 1; display: flex; align-items: center; }
    .group-chevron {
      color: var(--muted);
      font-size: 18px;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    .task-group.open .group-chevron { transform: rotate(180deg); }
    .progress-container {
      height: 4px;
      background: var(--progress-bg);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #34d399 100%);
      width: 0%;
      transition: width 0.4s ease;
      border-radius: 999px;
      box-shadow: 0 0 8px rgba(0,176,255,0.5);
    }

    /* ‚îÄ‚îÄ SUBTASKS ‚îÄ‚îÄ */
    .subtasks {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-group.open .subtasks { max-height: 2000px; }
    .subtasks-inner {
      padding: 6px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .subtask {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      background: #f8fafc;
      border-radius: 9px;
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: all 0.18s ease;
      gap: 12px;
    }
    .subtask:hover { background: #f0f6ff; border-left-color: var(--accent); }
    .subtask.completed { background: #f0fdf8; border-left-color: var(--success); }
    .subtask input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: var(--accent);
      cursor: pointer; flex-shrink: 0;
    }
    .subtask span {
      font-size: 14px; color: #2a3a4a;
      flex: 1; line-height: 1.4; font-weight: 400;
    }
    .subtask.completed span { text-decoration: line-through; color: #94a3b8; }
    .subtask img {
      width: 40px; height: 40px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(11,39,64,0.18);
      flex-shrink: 0;
    }
    .task-count {
      width: 68px;
      padding: 5px 8px;
      border-radius: 7px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: 'Source Sans 3', sans-serif;
      background: #fff;
      color: #1a2a3a;
      text-align: center;
      flex-shrink: 0;
      transition: border-color 0.2s;
    }
    .task-count:focus { outline: none; border-color: var(--accent); }
    .task-count::placeholder { color: #a0b0c0; }

    /* ‚îÄ‚îÄ TAG EVENTS ‚îÄ‚îÄ */
    .tag-events {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px;
    }
    @media (max-width: 540px) {
      .tag-events { grid-template-columns: 1fr; }
    }
    .tag-event-block {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tag-event-new { border-left: 3px solid var(--success); }
    .tag-event-lost { border-left: 3px solid #f87171; }
    .tag-event-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tag-event-icon {
      font-size: 15px;
      font-weight: 700;
      width: 24px; height: 24px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      font-family: 'Oswald', sans-serif;
    }
    .tag-event-new .tag-event-icon { background: rgba(16,185,129,0.15); color: var(--success); }
    .tag-event-lost .tag-event-icon { background: rgba(248,113,113,0.15); color: #e11d48; }
    .tag-event-title {
      font-family: 'Oswald', sans-serif;
      font-size: 0.82em;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--primary);
      flex: 1;
    }
    .tag-event-counter {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag-event-counter span {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 1.15em;
      min-width: 24px;
      text-align: center;
      color: var(--primary);
    }
    .counter-btn {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--primary);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      line-height: 1;
      padding: 0;
    }
    .counter-btn:hover { background: #f0f6ff; border-color: var(--accent); }
    .tag-event-notes {
      width: 100%;
      min-height: 56px;
      resize: vertical;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: 13px;
      font-family: 'Source Sans 3', sans-serif;
      background: #fff;
      color: #1a2a3a;
      transition: border-color 0.2s;
      line-height: 1.4;
    }
    .tag-event-notes:focus { outline: none; border-color: var(--accent); }
    .tag-event-notes::placeholder { color: #a0b0c0; }

    /* ‚îÄ‚îÄ REPORT SECTION ‚îÄ‚îÄ */
    .report-section {
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(11,39,64,0.08);
      padding: 18px 22px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .report-info {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 160px;
    }
    .report-info-progress {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 2em;
      color: var(--accent);
      letter-spacing: 0.02em;
      line-height: 1;
      min-width: 64px;
    }
    .report-info-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .report-info-meta span {
      font-size: 13px;
      color: var(--muted);
      font-family: 'Source Sans 3', sans-serif;
    }
    .report-info-meta span:first-child {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }
    .btn-report {
      font-family: 'Oswald', sans-serif;
      font-size: 0.95em;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      padding: 11px 28px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #04111f;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-shadow: 0 4px 14px rgba(0,176,255,0.3);
    }
    .btn-report:hover {
      background: #19b9ff;
      box-shadow: 0 6px 20px rgba(0,176,255,0.45);
      transform: translateY(-1px);
    }

    /* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
    #confetti { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }

    @media (max-width: 500px) {
      .report-section { flex-direction: column; align-items: stretch; }
      .btn-report { text-align: center; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <img src="./images/ITS_logo_horizont.png" alt="ITSSupport"
           onerror="this.style.display='none'">
      <span class="header-title">–ß–µ–∫-–ª–∏—Å—Ç –¥–µ–∂—É—Ä–Ω–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞</span>
    </div>
  </header>

  <div class="container">

    <div class="intro">
      <div class="intro-field">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="workDate">
      </div>
      <div class="intro-field">
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <input type="text" id="workerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
      </div>
      <p class="intro-hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á–∏ ¬∑ –û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∫–ª–∏–∫–æ–º</p>
    </div>

    <!-- –£–¢–†–û -->
    <div class="task-group" data-group="morning">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M12 2v4M4.93 7.93l2.83 2.83M2 16h4M18 16h4M16.24 10.76l2.83-2.83M5 16a7 7 0 0 1 14 0"/><line x1="3" y1="20" x2="21" y2="20"/></svg></span> –£—Ç—Ä–æ (6:00‚Äì8:00)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="morning"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-1">
          <span>–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–º–µ–Ω—ã</span>
          <img src="./images/propusk.jpg" alt="–ü—Ä–æ–ø—É—Å–∫–∞" onerror="this.style.display='none'">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-2">
          <span>–í—ã–¥–∞—á–∞ —á–∞—Å–æ–≤ –≤ –æ–∫–Ω–µ 6:00‚Äì8:00. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–æ–∫ —Å —á–∞—Å–∞–º–∏</span>
          <img src="./images/watches.jpg" alt="–ß–∞—Å—ã" onerror="this.style.display='none'">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-3">
          <span>–ó–∞–∫—Ä—ã—Ç–∏–µ –Ω–µ–æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –≤—ã–¥–∞—á–∏</span>
        </div>
      </div></div>
    </div>

    <!-- –§–†–û–ù–¢ -->
    <div class="task-group" data-group="front">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span> –î–µ–Ω—å: –§—Ä–æ–Ω—Ç (–Ω–æ–≤–µ–Ω—å–∫–∏–µ, –±–æ—Ç, —Ç–∞–±–µ–ª—å)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="front"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="front-1">
          <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–∏—á–∫–æ–≤</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-1" placeholder="0">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="front-2">
          <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–µ</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-2" placeholder="0">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="front-3">
          <span>–û–±—Ä–∞—â–µ–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–∞–±–µ–ª–µ–º</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-3" placeholder="0">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="front-4">
          <span>–ó–∞–º–µ–Ω–∞ –Ω–∞–∫–ª–µ–π–∫–∏ NFC</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="front-4" placeholder="0">
        </div>
      </div></div>
    </div>

    <!-- –ú–ï–¢–ö–ò -->
    <div class="task-group" data-group="tags">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><polyline points="6.5 6.5 17.5 17.5 12 23 12 1 17.5 6.5 6.5 17.5"/></svg></span> –î–µ–Ω—å: –ú–µ—Ç–∫–∏</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="tags"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-1">
          <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="tags-1" placeholder="0">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-4">
          <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: —Ä–∞–±–æ—Ç–∞ —Å –∂—É—Ä–Ω–∞–ª–æ–º BLE / backend</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="tags-5">
          <span>–ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è web-–∫–∞—Ä—Ç—ã</span>
        </div>
      </div></div>
    </div>

    <!-- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–û –ú–ï–¢–ö–ê–ú -->
    <div class="task-group" data-group="tag-events-block">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span> –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ç–∫–∞–º</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="tag-events-block" style="width:0%"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="tag-events">

          <div class="tag-event-block tag-event-new">
            <div class="tag-event-header">
              <span class="tag-event-icon">Ôºã</span>
              <span class="tag-event-title">–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏</span>
              <div class="tag-event-counter">
                <button class="counter-btn" onclick="changeCount('new', -1)">‚àí</button>
                <span id="countNew">0</span>
                <button class="counter-btn" onclick="changeCount('new', 1)">Ôºã</button>
              </div>
            </div>
            <textarea id="notesNew" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 101, 205, 318..."></textarea>
          </div>

          <div class="tag-event-block tag-event-lost">
            <div class="tag-event-header">
              <span class="tag-event-icon">‚àí</span>
              <span class="tag-event-title">–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏</span>
              <div class="tag-event-counter">
                <button class="counter-btn" onclick="changeCount('lost', -1)">‚àí</button>
                <span id="countLost">0</span>
                <button class="counter-btn" onclick="changeCount('lost', 1)">Ôºã</button>
              </div>
            </div>
            <textarea id="notesLost" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 42, 77..."></textarea>
          </div>

        </div>
      </div></div>
    </div>

    <!-- –í–ï–ß–ï–† -->
    <div class="task-group" data-group="evening">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span> –í–µ—á–µ—Ä (18:00‚Äì19:30)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="evening"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-1">
          <span>–ù–∞—Ä—É—à–µ–Ω–∏—è</span>
          <input type="number" min="0" value="0" class="task-count" data-count-for="evening-1" placeholder="0">
          <img src="./images/return.jpg" alt="–í–æ–∑–≤—Ä–∞—Ç" onerror="this.style.display='none'">
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-3">
          <span>–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞</span>
        </div>
      </div></div>
    </div>

    <!-- –û–¢–ß–Å–¢ -->
    <div class="report-section">
      <div class="report-info">
        <div class="report-info-progress" id="totalProgress">0%</div>
        <div class="report-info-meta">
          <span id="reportName">‚Äî</span>
          <span id="reportDate">‚Äî</span>
        </div>
      </div>
      <button class="btn-report" onclick="exportReport()">‚Üó –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
    </div>

  </div>

  <!-- Actions bar -->
  <!-- removed -->

  <canvas id="confetti"></canvas>

  <script>
    const STORAGE_KEY = 'itssupport_checklist_v5';

    function saveState() {
      const state = {
        tasks: Array.from(document.querySelectorAll('input[type="checkbox"]'))
          .map(cb => ({ id: cb.dataset.taskId, checked: cb.checked })),
        date: document.getElementById('workDate').value,
        name: document.getElementById('workerName').value,
        groups: Array.from(document.querySelectorAll('.task-group'))
          .map(g => ({ id: g.dataset.group, open: g.classList.contains('open') })),
        counts: Array.from(document.querySelectorAll('.task-count'))
          .map(inp => ({ id: inp.dataset.countFor, value: inp.value })),
        countNew: document.getElementById('countNew').textContent,
        countLost: document.getElementById('countLost').textContent,
        notesNew: document.getElementById('notesNew').value,
        notesLost: document.getElementById('notesLost').value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved) {
          saved.tasks?.forEach(({ id, checked }) => {
            const cb = document.querySelector(`[data-task-id="${id}"]`);
            if (cb) { cb.checked = checked; cb.closest('.subtask').classList.toggle('completed', checked); }
          });
          if (saved.date) document.getElementById('workDate').value = saved.date;
          if (saved.name) document.getElementById('workerName').value = saved.name;
          saved.groups?.forEach(({ id, open }) => {
            const group = document.querySelector(`[data-group="${id}"]`);
            if (group && open) group.classList.add('open');
          });
          saved.counts?.forEach(({ id, value }) => {
            const inp = document.querySelector(`.task-count[data-count-for="${id}"]`);
            if (inp) inp.value = value;
          });
          if (saved.countNew) document.getElementById('countNew').textContent = saved.countNew;
          if (saved.countLost) document.getElementById('countLost').textContent = saved.countLost;
          if (saved.notesNew) document.getElementById('notesNew').value = saved.notesNew;
          if (saved.notesLost) document.getElementById('notesLost').value = saved.notesLost;
        }
      } catch (e) {}
      updateAllProgress();
    }

    function updateGroupProgress(groupId) {
      const group = document.querySelector(`[data-group="${groupId}"]`);
      const tasks = group.querySelectorAll('input[type="checkbox"]');
      const checked = group.querySelectorAll('input[type="checkbox"]:checked').length;
      const percent = tasks.length ? Math.round((checked / tasks.length) * 100) : 0;
      group.querySelector('.progress-bar').style.width = percent + '%';
      return { checked, total: tasks.length };
    }

    function updateReportMeta() {
      const name = document.getElementById('workerName').value || '‚Äî';
      const date = document.getElementById('workDate').value || '‚Äî';
      document.getElementById('reportName').textContent = name;
      document.getElementById('reportDate').textContent = date;
    }

    function updateAllProgress() {
      let totalTasks = 0, totalChecked = 0;
      document.querySelectorAll('.task-group').forEach(group => {
        if (group.dataset.group === 'tag-events-block') return;
        const { checked, total } = updateGroupProgress(group.dataset.group);
        totalTasks += total;
        totalChecked += checked;
      });
      const pct = totalTasks ? Math.round((totalChecked / totalTasks) * 100) : 0;
      document.getElementById('totalProgress').textContent = pct + '%';
      updateReportMeta();
      if (pct === 100) showConfetti();
    }

    function changeCount(type, delta) {
      const el = document.getElementById(type === 'new' ? 'countNew' : 'countLost');
      const current = parseInt(el.textContent) || 0;
      el.textContent = Math.max(0, current + delta);
      saveState();
    }

    function resetAll() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —á–µ–∫-–ª–∏—Å—Ç?')) return;
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.closest('.subtask').classList.remove('completed');
      });
      document.querySelectorAll('.task-count').forEach(inp => inp.value = 0);
      document.getElementById('countNew').textContent = '0';
      document.getElementById('countLost').textContent = '0';
      document.getElementById('notesNew').value = '';
      document.getElementById('notesLost').value = '';
      updateAllProgress();
      saveState();
    }

    function showConfetti() {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#00b0ff','#34d399','#f59e0b','#f87171','#a78bfa'];
      for (let i = 0; i < 120; i++) {
        pieces.push({
          x: Math.random() * canvas.width, y: -10,
          vx: (Math.random() - 0.5) * 8, vy: Math.random() * 5 + 3,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 7 + 3,
          rot: Math.random() * 360, rotV: (Math.random() - 0.5) * 8
        });
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach((p, i) => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.rotV;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
          if (p.y > canvas.height) pieces.splice(i, 1);
        });
        if (pieces.length) requestAnimationFrame(animate);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      animate();
    }

    async function fetchBleCount() {
      try {
        const SHEET_ID = '1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c';
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent('–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë')}&range=J22&headers=0&t=${Date.now()}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const val = json?.table?.rows?.[0]?.c?.[0]?.v;
        return val !== null && val !== undefined ? String(val) : '‚Äî';
      } catch { return '‚Äî'; }
    }

    async function exportReport() {
      const name = document.getElementById('workerName').value || '–ò–Ω–∂–µ–Ω–µ—Ä';
      const date = document.getElementById('workDate').value || new Date().toLocaleDateString('ru-RU');

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî –≤—Å—ë –∫—Ä–æ–º–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ (tags-1), –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º —Ñ—Ä–æ–Ω—Ç-–¥–∞–Ω–Ω—ã–µ
      const frontFields = [
        { id: 'front-1', label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–∏—á–∫–æ–≤' },
        { id: 'front-2', label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–µ' },
        { id: 'front-3', label: '–û–±—Ä–∞—â–µ–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–∞–±–µ–ª–µ–º' },
        { id: 'front-4', label: '–ó–∞–º–µ–Ω–∞ –Ω–∞–∫–ª–µ–π–∫–∏ NFC' },
        { id: 'evening-1', label: '–ù–∞—Ä—É—à–µ–Ω–∏—è' },
      ];

      const statsLines = frontFields.map(f => {
        const value = parseInt(document.querySelector(`.task-count[data-count-for="${f.id}"]`)?.value || '0') || 0;
        return { label: f.label, value };
      }).filter(item => item.value > 0);

      // –ú–µ—Ç–∫–∏
      const walkedCount = parseInt(document.querySelector('.task-count[data-count-for="tags-1"]')?.value || '0') || 0;
      const countNew = parseInt(document.getElementById('countNew').textContent) || 0;
      const countLost = parseInt(document.getElementById('countLost').textContent) || 0;
      const notesNew = document.getElementById('notesNew').value.trim();
      const notesLost = document.getElementById('notesLost').value.trim();

      // BLE count from Google Sheets
      const bleCount = await fetchBleCount();

      let report = `üìÖ ${date}\n`;
      report += `–û—Ç—á—ë—Ç –ø–æ —Å–º–µ–Ω–µ:\n`;
      report += `${name}\n`;

      if (statsLines.length) {
        report += `\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n`;
        statsLines.forEach(item => { report += `  ‚Ä¢ ${item.label}: ${item.value}\n`; });
      }

      report += `\n–ú–µ—Ç–∫–∏:\n`;
      report += `  ‚Ä¢ –ü—Ä–æ–π–¥–µ–Ω–æ: ${walkedCount} —à—Ç.\n`;
      if (countNew > 0) {
        report += `  ‚Ä¢ –ù–æ–≤—ã–µ: ${countNew} —à—Ç.`;
        if (notesNew) report += ` (${notesNew})`;
        report += `\n`;
      }
      if (countLost > 0) {
        report += `  ‚Ä¢ –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ: ${countLost} —à—Ç.`;
        if (notesLost) report += ` (${notesLost})`;
        report += `\n`;
      }
      report += `  ‚Ä¢ –í—Å–µ–≥–æ BLE-–º–µ—Ç–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞¬ª: ${bleCount} —à—Ç.\n`;

      const webMapChecked = document.querySelector('input[data-task-id="tags-5"]')?.checked;
      if (webMapChecked) report += `  ‚Ä¢ Web-–∫–∞—Ä—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\n`;

      copyToClipboard(report);
    }

    function copyToClipboard(text) {
      // iOS Safari requires a different approach
      const isIOS = /ipad|iphone|ipod/i.test(navigator.userAgent);

      if (isIOS) {
        const el = document.createElement('textarea');
        el.value = text;
        el.style.cssText = 'position:fixed;top:0;left:0;opacity:0;font-size:16px;';
        document.body.appendChild(el);
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        el.setSelectionRange(0, text.length);
        let success = false;
        try { success = document.execCommand('copy'); } catch(e) {}
        document.body.removeChild(el);
        if (success) {
          alert('‚úÖ –û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n–í—Å—Ç–∞–≤—å—Ç–µ –≤ Telegram –∏–ª–∏ –¥—Ä—É–≥–æ–π —á–∞—Ç.');
        } else {
          prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –≤—Ä—É—á–Ω—É—é:', text);
        }
      } else {
        navigator.clipboard.writeText(text)
          .then(() => alert('‚úÖ –û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n–í—Å—Ç–∞–≤—å—Ç–µ –≤ Telegram –∏–ª–∏ –¥—Ä—É–≥–æ–π —á–∞—Ç.'))
          .catch(() => prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç:', text));
      }
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('workDate').valueAsDate = new Date();
      loadState();

      document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('open');
          saveState();
        });
      });

      document.querySelectorAll('.subtask').forEach(subtask => {
        subtask.addEventListener('click', function(e) {
          const checkbox = this.querySelector('input[type="checkbox"]');
          const isCount = e.target.classList.contains('task-count');
          if (!isCount && e.target !== checkbox && checkbox) {
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('completed', checkbox.checked);
          }
          saveState();
          updateAllProgress();
        });
      });

      document.querySelectorAll('.task-count').forEach(inp => {
        inp.addEventListener('input', saveState);
      });

      document.getElementById('notesNew').addEventListener('input', saveState);
      document.getElementById('notesLost').addEventListener('input', saveState);
      document.getElementById('workDate').addEventListener('change', () => { saveState(); updateReportMeta(); });
      document.getElementById('workerName').addEventListener('input', () => { saveState(); updateReportMeta(); });
    });

    window.addEventListener('beforeunload', saveState);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) saveState(); });
  </script>
</body>
</html>
